package com.sunrise.boss.ui.cms.rewardadjust;


import java.text.SimpleDateFormat;
import java.util.HashMap;

import org.apache.commons.lang.StringUtils;
import org.apache.commons.lang.math.NumberUtils;
import org.apache.struts.upload.FormFile;

import com.sunrise.boss.business.cms.way.persistent.WayVO;
import com.sunrise.boss.common.exception.business.BusinessException;
import com.sunrise.boss.delegate.cms.way.WayDelegate;
import com.sunrise.boss.ui.commons.User;
import com.sunrise.boss.ui.commons.batch.upload.BaseCheckFormat;
import com.sunrise.pub.tools.StringSplit;

public class RewardadjustbatchCheck extends BaseCheckFormat {
	
	private WayDelegate waydelegate;
	/**
	 * 1.调整类别
	 * PUNISH:扣减;RETURN:返回;BONUS:奖励;
	 */
	protected static HashMap ADJUSTKIND_MAP=new HashMap();
	/**
	 * 2.酬金调整方式
					EFTCURMONTH:仅影响当月酬金(适用"扣减","返还"和"奖励")
					EFTCURORAFTERMONTH
	 */
	protected static HashMap ADJUSTTYPE_MAP=new HashMap();
	/**
	 * 3.调整原因类型
					扣减:
						P-CH:串货;P-PTWG:排他违规;P-YWWG:业务违规;P-QTYY 其他原因扣减
					返还:
						R-DKBH:多扣补还;R-LSBG:漏算补给;R-QTYY:其他原因返还
					奖励:
						B-YWJL 业务奖励;
	 */
	protected static HashMap REASONTYPE_MAP=new HashMap();
	
	public RewardadjustbatchCheck() throws Exception {
		ADJUSTKIND_MAP.put("PUNISH", "PUNISH");
		ADJUSTKIND_MAP.put("RETURN", "PUNISH");
		ADJUSTKIND_MAP.put("BONUS", "PUNISH");
		ADJUSTKIND_MAP.put("EFTCURORAFTERMONTH", "EFTCURORAFTERMONTH");
		ADJUSTKIND_MAP.put("EFTCURMONTH", "EFTCURMONTH");
		REASONTYPE_MAP.put("P-CH", "P-CH");
		REASONTYPE_MAP.put("P-PTWG", "P-PTWG");
		REASONTYPE_MAP.put("P-YWWG", "P-YWWG");
		REASONTYPE_MAP.put("P-QTYY", "P-QTYY");
		REASONTYPE_MAP.put("R-DKBH", "R-DKBH");
		REASONTYPE_MAP.put("R-LSBG", "R-LSBG");
		REASONTYPE_MAP.put("R-QTYY", "R-QTYY");
		REASONTYPE_MAP.put("B-YWJL", "B-YWJL");
		waydelegate = new WayDelegate();
	}

	public void checkFile(FormFile file, HashMap parameterMap) throws Exception {
		if (!"text/plain".equalsIgnoreCase(file.getContentType())) {
			throw new BusinessException("","要导入的文件类型不正确，本系统只导入指定的文件格式：txt文本文件!");
		}
	}
	
	public void checkLine(String line, int rowCount, User user) throws Exception {
		
		String[] content =StringSplit.split(line, "|");
		
		if (content.length == 8) {
			;
		}else{
			throw new BusinessException("","参数不完整.应该有7项");
		}

		SimpleDateFormat format=new SimpleDateFormat("yyyyMM");
		format.setLenient(false);
		/**
		 * PUNISH:扣减;RETURN:返回;BONUS:奖励;
		 */
		if(StringUtils.isEmpty(content[0]) || !ADJUSTKIND_MAP.containsKey(content[0]) || content[0].length() >32){
			throw new BusinessException("","调整类别类型不正确!");
		}
		if(StringUtils.isEmpty(content[1]) || content[1].length() >18){
			throw new BusinessException("","网点编码不能为空!");
		}
		
		if (StringUtils.isEmpty(content[2])) {
			throw new BusinessException("", "作用结算月不合法,不能为空!");
		}
		if(content[2].length() != 6){
			throw new BusinessException("", "作用结算月不合法,长度必须为6位!");
		}
		
		if(!NumberUtils.isNumber(content[2])){
			throw new BusinessException("", "作用结算月不合法,只能为数字!");
		}
			
		try {
			format.parse(content[2]);
		} catch (Exception e) {
			throw new BusinessException("", "作用结算月不合法,应为6位年月数字!");
		}
		String regex = "^([1-9]\\d{3}[0][1-9])|([1-9]\\d{3}[1][0-2])$";
		if (!content[2].matches(regex)) {
			throw new BusinessException("", "作用结算月不合法,月份范围应为[01-12]!");
		}
		
		try {
			format.parse(content[7]);
		} catch (Exception e) {
			throw new BusinessException("", "酬金发生月不合法,应为6位年月数字!");
		}
		if (!content[7].matches(regex)) {
			throw new BusinessException("", "酬金发生月不合法,月份范围应为[01-12]!");
		}
		
		if(Integer.parseInt(content[2]) < Integer.parseInt(content[7])){
			throw new BusinessException("", "酬金发生月应当小于等于作用结算月!");
		}
		
//		 金额校验
		if (StringUtils.isEmpty(content[3]) || !NumberUtils.isNumber(content[3])) {
			throw new BusinessException("", "调整金额不合法,应为数字,支持两位小数");
		}
		try {
			if (!(checkAmtFormat(content[3], 10)))
				throw new Exception("调整金额不合法,(" + content[3]
						+ ")整数部分最多10位，如有小数部分则一定是2位!");
		} catch (Exception e) {
			throw new Exception("调整金额不合法,(" + content[3]
					+ ")整数部分最多10位，如有小数部分则一定是2位!");
		}
	
		if(StringUtils.isEmpty(content[4]) || !ADJUSTKIND_MAP.containsKey(content[4]) || content[4].length() >32){
			throw new BusinessException("","调整方式类型不正确!");
		}
		
		if(StringUtils.isEmpty(content[5]) || !",".equals(content[5].substring(content[5].length()-1)) || content[5].length() >32){
			throw new BusinessException("","调整原因类型不正确!");
		}
		if(StringUtils.isEmpty(content[6]) || content[6].length() >500){
			throw new BusinessException("","备注不正确!");
		}
		String[] reasontype = content[5].split(",");
		for (int i=0;i<reasontype.length;i++) {
			if (!REASONTYPE_MAP.containsKey(reasontype[i])) {
				throw new BusinessException("","调整原因类型不正确!");
			}
		}

		WayVO wayvo=waydelegate.doFindByPk(content[1], user);
		if(wayvo==null){
			throw new BusinessException("","网点代码不存在");
		}
		if ("RETURN".equals(content[0])||("BONUS".equals(content[0]))) {
			if (!"EFTCURMONTH".equals(content[4])) {
				throw new BusinessException("","'调整类别'选择'RETURN返还'或'BONUS奖励'时，'调整方式'必须是'EFTCURMONTH'仅影响当前月酬金!");
			}
		}
	}
	public boolean checkAmtFormat(String amt, int length) {
		amt = amt.trim();
		if (amt.indexOf(".") != -1) {
			if (amt.indexOf(".") == 0) {
				return false;
			}
			if (amt.indexOf(".") > length) {
				return false;
			}
			if ((amt.length() - amt.indexOf(".")) != 3) {
				return false;
			}
		} else {
			if (amt.length() > length) {
				return false;
			}
		}
		return true;
	}
}
		
